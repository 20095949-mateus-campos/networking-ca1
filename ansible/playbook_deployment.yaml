# Module Title:         Network Systems and Administration
# Module Code:          B9IS121
# Module Instructor:    Kingsley Ibomo
# Assessment Title:     Automated Container Deployment and Administration in the Cloud
# Assessment Number:    1
# Assessment Type:      Practical
# Assessment Weighting: 60%
# Assessment Due Date:  Sunday, 9 November 2025, 8:36 AM
# Student Name:         Mateus Fonseca Campos
# Student ID:           20095949
# Student Email:        20095949@mydbs.ie
# GitHub Repo:          https://github.com/20095949-mateus-campos/networking-ca1

# This file belongs to Part 3: Docker Container Deployment

# Downloads, installs and configures Docker on the web server
- name: Deploy Docker containers
  hosts: web_servers

  # Loads environment variables from .env file
  vars:
    env: "{{ lookup('ansible.builtin.file', '../.env') }}"

  tasks:
    # Deploys Docker containers to web server
    # builds and pushes local Docker image to remote repository
    - name: Build and push Docker image
      local_action:
        module: shell
        cmd: |
          "docker login -u $(echo {{ env }} | grep -w DOCKER_USERNAME | sed -e 's/.*=//') -p $(echo {{ env }} | grep -w DOCKERHUB_TOKEN | sed -e 's/.*=//')"
          docker build -t 20095949/networking-ca1:latest ../flask/.
          docker push 20095949/networking-ca1:latest
    # creates directory to house Nginx file(s) on the web server
    - name: Create Nginx directory
      ansible.builtin.file:
        path: ~/nginx
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
    # creates directory to house Docker compose file on the web server
    - name: Create Docker directory
      ansible.builtin.file:
        path: ~/docker
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
    # copies Docker compose file and nginx config file from local host to remote host
    - name: Copy Docker and Nginx files
      ansible.builtin.copy:
        src: "{{ item.src }}" 
        dest: "{{ item.dest }}"
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      loop:
        - src: ../docker/compose.yaml
          dest: ~/docker/compose.yaml
        - src: ../nginx/default.conf
          dest: ~/nginx/default.conf
    # pulls and runs Docker containers on the web server
    - name: Pull and run Docker image
      ansible.builtin.shell: |
        "docker login -u $(echo {{ env }} | grep -w DOCKER_USERNAME | sed -e 's/.*=//') -p $(echo {{ env }} | grep -w DOCKERHUB_TOKEN | sed -e 's/.*=//')"
        cd docker
        sudo docker compose pull
        sudo docker stop $(sudo docker ps -a -q) || true
        sudo docker system prune -f
        sudo docker compose up -d
